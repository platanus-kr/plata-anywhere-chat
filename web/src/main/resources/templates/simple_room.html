<html>
<head>
    <title>chat service test</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style-chatroom.css}"/>
</head>

<body>
<div class="wrap max-w-md mx-auto bg-white">

    <div class="enter-room box-border p-4 ">

        <label for="chat-nickname-init" class="block text-sm font-medium leading-6 text-gray-900">닉네임</label>
        <input type="text" name="chat-nickname-init" id="chat-nickname-init" class="chat-input-nickname-init block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" value="" disabled />

        <label for="chat-room" class="block text-sm font-medium leading-6 text-gray-900">채팅방 명 </label>
        <input type="text" name="chat-room" id="chat-room" class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" value="test" />

        <input type="button" class="chat-input-room-button rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600" value="입장" onclick="sendSubscribe()" />

    </div>

    <div class="chat-service ">
        <div class="room-action-menu">
            <span>작동</span>
        </div>
        <div class="chat-input">
            <input type="text" id="chat-id" class="chat-input-id" value="test"/>
            <input type="text" id="chat-text" class="chat-input-text"/>
            <input type="button" class="chat-input-send-button rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600" value="전송" onclick="sendMessageWrap()"/>
        </div>
        <div class="stream-box">
            <div class="inner-box">
                <div class="chat-line"> <!-- overflow add check! -->
                    <div class="member-profile">
                        <div class="member-profile-image">

                        </div>
                        <div class="member-nickname">
                            <span>닉네임</span>
                        </div>
                    </div>
                    <div class="member-text">
                        <span>채팅 내용</span>
                    </div>
                    <div class="chat-action-menu">

                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

<script>

    let socket = '';
    const nickname = makeId(5);
    let chatRoomName = '';
    $(document).ready(function () {
        $(".chat-input-nickname-init").val(nickname);

        socket = new WebSocket('ws://localhost:3121/message');
        socket.onopen = function (event) {
            // 연결이 열리면 실행되는 코드
            console.log('WebSocket 연결이 열렸습니다.');
        };


        $(".chat-input-id").val(nickname);

        socket.addEventListener('message', function (data) {
            let response = JSON.parse(data.data);
            console.log('Message from server: ', response);
            $('.chat-line').append('<p><b>' + response.identifier.nickname + '</b> : ' + response.message + ' | <span>'+ response.timestamp +'</span></p>');
        });
    })

    function sendSubscribe() {
        chatRoomName = $(".chat-input-room").val();
        if (chatRoomName.length < 1) {
            alert("채팅방 명을 입력해야 합니다");
            return;
        }

        console.log("입장");
        let identifier = {
            channel: chatRoomName,
            nickname: nickname
        }
        let message = {
            command: "subscribe",
            identifier: identifier
        }
        console.log(message);
        socket.send(JSON.stringify(message));
        $(".enter-room").css("display", "none");
        // $(".chat-service").css("display");
        $(".chat-service").css("display", "block");
    }

    function makeId(length) {
        let result = '';
        const characters = 'abcdefghijklmnopqrstuvwxyz0123456789';
        const charactersLength = characters.length;
        let counter = 0;
        while (counter < length) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
            counter += 1;
        }
        return result;
    }


    function sendMessageWrap() {
        const chatText = $("#chat-text").val();
        let identifier = {
            channel: chatRoomName,
            nickname: nickname
        }
        let message = {
            command: "message",
            message: chatText,
            identifier: identifier
        }
        socket.send(JSON.stringify(message));

    }

</script>

</body>
</html>
