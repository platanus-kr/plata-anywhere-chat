<!DOCTYPE html>
<html lang="ko"
      th:replace="~{layout/chat/layout :: layout(~{::title}, ~{::section})}">
<head>
    <meta charset="UTF-8">
    <title>PAC</title>
</head>
<body>
<section>

    <div class="enter-room sm:w-[42rem] p-4 pt-6 box-border">
        <div class="flex flex-wrap">
            <div class="member-information pb-10 hidden">
                <p><b>ğŸ•µï¸â€â™€ï¸ íšŒì› ì •ë³´</b></p>
                <p><span th:text="${member}"></span></p>
            </div>
            <h1 class="w-full block">ì±„íŒ…ë°© ëª©ë¡</h1>

            <input type="hidden" id="pacSessionId" th:value="${pacsessionid}"/>
            <input type="hidden" id="pacUserId" th:value="${member.id}"/>
            <input type="hidden" id="pacNickname" th:value="${member.nickname}"/>
            <input type="hidden" id="messageServer" th:value="${messageServer}"/>
            <input type="hidden" id="isChatSessionValid" th:value="${isChatSessionValid}"/>
            <input type="hidden" id="sessionValidErrorMessage" th:value="${sessionValidErrorMessage}"/>
            <hr/>

            <label for="chat-nickname-init"
                   class="text-sm font-medium leading-6 text-gray-900">
                ì±„íŒ…ë°©ì—ì„œ ì‚¬ìš© í•  ë‹‰ë„¤ì„
            </label>
            <input type="text"
                   name="chat-nickname-init"
                   id="chat-nickname-init"
                   class="chat-input-nickname-init block w-full rounded-md border-0 px-2 py-1.5 text-gray-900 shadow-sm placeholder:text-gray-400 sm:text-sm sm:leading-6"
                   th:value="${member.nickname}"
                   disabled/>

            <p class="text-sm font-medium mt-5 leading-6 text-gray-900">ì ‘ê·¼ ê°€ëŠ¥í•œ ì±„íŒ…ë°© ëª©ë¡</p>

            <div class="room-list block w-full">
                <ul role="list" class="divide-y divide-gray-100">
                    <li class="flex justify-between gap-x-6 p-3 hover:bg-slate-50">
                        <div class="flex gap-x-4">
                            <img class="h-12 w-12 flex-none rounded-full bg-gray-50"
                                 src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"
                                 alt="">
                            <div class="min-w-0 flex-auto">
                                <p class="text-sm font-semibold leading-6 text-gray-900">ì±„íŒ…ë°© ì´ë¦„</p>
                                <p class="mt-1 truncate text-xs leading-5 text-gray-500">
                                <span class="border-solid border-2 rounded-md text-slate-50 bg-indigo-500 border-indigo-600 px-3">ì±„íŒ…ê°€ëŠ¥</span> <span>1/100</span></p>
                            </div>
                        </div>
                        <div class="hidden sm:flex sm:flex-col sm:items-end">
                            <p class="text-sm leading-6 text-gray-900">test1</p>
                            <p class="mt-1 text-xs leading-5 text-gray-500">ë°© ìƒì„± ì‹œê°„
                                <time datetime="2023-01-23T13:23Z">3h ago</time>
                            </p>
                        </div>
                    </li>

                    <li class="flex justify-between gap-x-6 p-3 hover:bg-slate-50">
                        <div class="flex gap-x-4">
                            <img class="h-12 w-12 flex-none rounded-full bg-gray-50"
                                 src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"
                                 alt="">
                            <div class="min-w-0 flex-auto">
                                <p class="text-sm font-semibold leading-6 text-gray-900">ì±„íŒ…ë°© ì´ë¦„</p>
                                <p class="mt-1 truncate text-xs leading-5 text-gray-500">
                                    <span class="border-solid border-2 rounded-md text-slate-50 bg-indigo-500 border-indigo-600 px-3">ì±„íŒ…ê°€ëŠ¥</span> <span>1/100</span></p>
                            </div>
                        </div>
                        <div class="hidden sm:flex sm:flex-col sm:items-end">
                            <p class="text-sm leading-6 text-gray-900">test1</p>
                            <p class="mt-1 text-xs leading-5 text-gray-500">ë°© ìƒì„± ì‹œê°„
                                <time datetime="2023-01-23T13:23Z">3h ago</time>
                            </p>
                        </div>
                    </li>

                    <li class="flex justify-between gap-x-6 p-3 hover:bg-slate-50">
                        <div class="flex gap-x-4">
                            <img class="h-12 w-12 flex-none rounded-full bg-gray-50"
                                 src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"
                                 alt="">
                            <div class="min-w-0 flex-auto">
                                <p class="text-sm font-semibold leading-6 text-gray-900">ì±„íŒ…ë°© ì´ë¦„</p>
                                <p class="mt-1 truncate text-xs leading-5 text-gray-500">
                                    <span class="border-solid border-2 rounded-md text-slate-50 bg-indigo-500 border-indigo-600 px-3">ì±„íŒ…ê°€ëŠ¥</span> <span>1/100</span></p>
                            </div>
                        </div>
                        <div class="hidden sm:flex sm:flex-col sm:items-end">
                            <p class="text-sm leading-6 text-gray-900">test1</p>
                            <p class="mt-1 text-xs leading-5 text-gray-500">ë°© ìƒì„± ì‹œê°„
                                <time datetime="2023-01-23T13:23Z">3h ago</time>
                            </p>
                        </div>
                    </li>

                    <li class="flex justify-between gap-x-6 p-3 hover:bg-slate-50">
                        <div class="flex gap-x-4">
                            <img class="h-12 w-12 flex-none rounded-full bg-gray-50"
                                 src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"
                                 alt="">
                            <div class="min-w-0 flex-auto">
                                <p class="text-sm font-semibold leading-6 text-gray-900">ì±„íŒ…ë°© ì´ë¦„</p>
                                <p class="mt-1 truncate text-xs leading-5 text-gray-500">
                                    <span class="border-solid border-2 rounded-md text-slate-50 bg-indigo-500 border-indigo-600 px-3">ì±„íŒ…ê°€ëŠ¥</span> <span>1/100</span></p>
                            </div>
                        </div>
                        <div class="hidden sm:flex sm:flex-col sm:items-end">
                            <p class="text-sm leading-6 text-gray-900">test1</p>
                            <p class="mt-1 text-xs leading-5 text-gray-500">ë°© ìƒì„± ì‹œê°„
                                <time datetime="2023-01-23T13:23Z">3h ago</time>
                            </p>
                        </div>
                    </li>

                    <li class="flex justify-between gap-x-6 p-3 hover:bg-slate-50">
                        <div class="flex gap-x-4">
                            <img class="h-12 w-12 flex-none rounded-full bg-gray-50"
                                 src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"
                                 alt="">
                            <div class="min-w-0 flex-auto">
                                <p class="text-sm font-semibold leading-6 text-gray-900">ì±„íŒ…ë°© ì´ë¦„</p>
                                <p class="mt-1 truncate text-xs leading-5 text-gray-500">
                                    <span class="border-solid border-2 rounded-md text-slate-50 bg-indigo-500 border-indigo-600 px-3">ì±„íŒ…ê°€ëŠ¥</span> <span>1/100</span></p>
                            </div>
                        </div>
                        <div class="hidden sm:flex sm:flex-col sm:items-end">
                            <p class="text-sm leading-6 text-gray-900">test1</p>
                            <p class="mt-1 text-xs leading-5 text-gray-500">ë°© ìƒì„± ì‹œê°„
                                <time datetime="2023-01-23T13:23Z">3h ago</time>
                            </p>
                        </div>
                    </li>

                    <li class="flex justify-between gap-x-6 p-3 hover:bg-slate-50">
                        <div class="flex gap-x-4">
                            <img class="h-12 w-12 flex-none rounded-full bg-gray-50"
                                 src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"
                                 alt="">
                            <div class="min-w-0 flex-auto">
                                <p class="text-sm font-semibold leading-6 text-gray-900">ì±„íŒ…ë°© ì´ë¦„</p>
                                <p class="mt-1 truncate text-xs leading-5 text-gray-500">
                                    <span class="border-solid border-2 rounded-md text-slate-50 bg-indigo-500 border-indigo-600 px-3">ì±„íŒ…ê°€ëŠ¥</span> <span>1/100</span></p>
                            </div>
                        </div>
                        <div class="hidden sm:flex sm:flex-col sm:items-end">
                            <p class="text-sm leading-6 text-gray-900">test1</p>
                            <p class="mt-1 text-xs leading-5 text-gray-500">ë°© ìƒì„± ì‹œê°„
                                <time datetime="2023-01-23T13:23Z">3h ago</time>
                            </p>
                        </div>
                    </li>


                </ul>
            </div>

            <div class="ml-auto flex flex-wrap justify-center">
                <div class="server-status self-center">
                    <p class="ok mr-5 hidden text-lime-500">ì„œë²„ ì •ìƒ</p>
                    <p class="error mr-5 hidden text-rose-400 underline decoration-rose-200"
                       onclick="location.reload()">ì±„íŒ… ì„œë²„ ì ‘ì† ë¶ˆê°€</p>
                </div>
                <button type="button"
                        class="chat-input-room-button text-gray-900 bg-white hover:bg-gray-100 border border-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 font-medium rounded-lg text-sm  my-3 px-3 py-2 text-center inline-flex items-center dark:focus:ring-gray-600 dark:bg-gray-800 dark:border-gray-700 dark:text-white dark:hover:bg-gray-700"
                        onclick="sendSubscribe()">
                    ì…ì¥
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6">
                        <path d="M6 7H18V12C18 15.3137 15.3137 18 12 18V18C8.68629 18 6 15.3137 6 12V7Z"
                              stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="15" y1="2" x2="15" y2="7" stroke="#000000" stroke-width="2" stroke-linecap="round"
                              stroke-linejoin="round"/>
                        <path d="M12 18V22" stroke="#000000" stroke-width="2" stroke-linecap="round"
                              stroke-linejoin="round"/>
                        <line x1="9" y1="2" x2="9" y2="7" stroke="#000000" stroke-width="2" stroke-linecap="round"
                              stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>

        </div>
    </div>


    <script>

        let socket = '';
        let socketOnErrorStatus = false;
        const nickname = document.getElementById('pacNickname').value;
        const pacSessionId = document.getElementById('pacSessionId').value;
        const pacUserId = document.getElementById('pacUserId').value;
        const messageServer = document.getElementById('messageServer').value;
        const isChatSessionValid = document.getElementById('isChatSessionValid').value;
        const sessionValidErrorMessage = document.getElementById('sessionValidErrorMessage').value;
        let chatRoomName = '';
        $(document).ready(function () {

            if (isChatSessionValid === 'false') {
                alert(sessionValidErrorMessage);
                location.href = '/chat/lobby';
            }


            socket = new WebSocket('ws://' + messageServer + '/simplemessage');
            socket.onopen = function (event) {
                // ì—°ê²°ì´ ì—´ë¦¬ë©´ ì‹¤í–‰ë˜ëŠ” ì½”ë“œ
                console.log('WebSocket ì—°ê²°ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.');
                $(".server-status .ok").removeClass("hidden");
            };

            socket.onerror = function (error) {
                console.error('WebSocket ì—°ê²° ì—ëŸ¬:', error);
                // ì—ëŸ¬ ì²˜ë¦¬ ë¡œì§ì„ ì¶”ê°€í•˜ì„¸ìš”
                socketOnErrorStatus = true;
                $(".server-status .error").removeClass("hidden");
            };

            socket.onclose = function (event) {
                if (event.wasClean) {
                    console.log('WebSocket ì—°ê²°ì´ ì •ìƒì ìœ¼ë¡œ ë‹«í˜”ìŠµë‹ˆë‹¤.');
                    alert("ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
                    location.reload();
                } else {
                    console.error('WebSocket ì—°ê²°ì´ ë¹„ì •ìƒì ìœ¼ë¡œ ë‹«í˜”ìŠµë‹ˆë‹¤.');
                    if (socketOnErrorStatus === false) {
                        alert("ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
                        location.reload();
                    }
                    $(".server-status .ok").addClass("hidden");
                    $(".server-status .error").removeClass("hidden");
                }
            };

            const roomList = getRoomList();

            // $(".chat-input-id").val(nickname);
            document.querySelector(".chat-input-id").value = nickname;

        })

        /**
         * {
         *     "content": [
         *         {
         *             "roomId": "04949b5e-ef24-43cb-960e-0def123ca8a2",
         *             "name": "í…ŒìŠ¤íŠ¸ë°©",
         *             "description": "í…ŒìŠ¤íŠ¸ ì±„íŒ…ë°©",
         *             "imageUrl": "#",
         *             "capacity": 100,
         *             "roomMembersCount": 1,
         *             "roomStatus": "ALIVE",
         *             "roomPublic": "AVAILABLE",
         *             "participates": null,
         *             "owner": {
         *                 "id": "828f1a2f-8eda-4bbc-9e28-918ef98537cf",
         *                 "nickname": "í…ŒìŠ¤íŠ¸1",
         *                 "status": null,
         *                 "role": null,
         *                 "joinDateTime": null
         *             }
         *         },
         *         ......
         *     ],
         *     "pageable": {
         *         "sort": {
         *             "empty": true,
         *             "sorted": false,
         *             "unsorted": true
         *         },
         *         "offset": 0,
         *         "pageNumber": 0,
         *         "pageSize": 10,
         *         "paged": true,
         *         "unpaged": false
         *     },
         *     "last": false,
         *     "totalPages": 3,
         *     "totalElements": 21,
         *     "first": true,
         *     "number": 0,
         *     "sort": {
         *         "empty": true,
         *         "sorted": false,
         *         "unsorted": true
         *     },
         *     "size": 10,
         *     "numberOfElements": 10,
         *     "empty": false
         * }
         */
        function getRoomList() {
            $.ajax({
                url: '/api/v1/room/list',
                type: 'GET',
                data: {
                    page: 1
                }
            }).done(function (data) {
                console.log(data);
                const roomListAsPage = data.content;
                console.log(roomListAsPage);
                let paging = {
                    "totalPages": data.totalPages,
                    "totalElements": data.totalElements,
                    "nowPage": data.number
                }
                console.log(paging);
            }).fail(function (error) {
                console.log(error);
                alert("ì±„íŒ…ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        }

        function sendSubscribe() {

            // $.ajax({
            //     url: '/chat/room/check',
            //     type: 'POST',
            //     data: {
            //         chatRoomName: document.querySelector(".chat-input-room").value
            //     },
            //     success: function (data) {
            //         if (data === 'true') {
            //             alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì±„íŒ…ë°© ì…ë‹ˆë‹¤.");
            //             return;
            //         }
            //         sendSubscribeWrap();
            //     },
            //     error: function (error) {
            //         console.log(error);
            //     }
            // });


            if (socketOnErrorStatus === true) {
                alert("ì„œë²„ì— ì ‘ì† í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            chatRoomName = document.querySelector(".chat-input-room").value;
            if (chatRoomName.length < 1) {
                alert("ì±„íŒ…ë°© ëª…ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤");
                return;
            }

            console.log("ì…ì¥");
            let identifier = {
                channel: chatRoomName,
                memberId: pacUserId,
                nickname: nickname,
                token: pacSessionId
            }
            let message = {
                command: "SUBSCRIBE",
                identifier: identifier
            }
            console.log(message);
            socket.send(JSON.stringify(message));
            document.querySelector(".enter-room").classList.add("hidden");
            document.querySelector(".chat-service").classList.remove("hidden");
        }

        function sendMessageWrap() {
            const chatText = document.querySelector("#chat-text").value;
            let identifier = {
                channel: chatRoomName,
                memberId: pacUserId,
                nickname: nickname,
                token: pacSessionId
            }
            let message = {
                command: "MESSAGE",
                message: chatText,
                identifier: identifier
            }
            socket.send(JSON.stringify(message));
            document.querySelector("#chat-text").value = "";
        }


    </script>
</section>
</body>
</html>